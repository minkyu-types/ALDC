# CLAUDE.MD - A Long Dark Cave (ALDC)

## Project Overview

**A Long Dark Cave** is a motivation and goal-tracking app inspired by Norse mythology, specifically the legend of Askâ€”the first human created by the gods from the roots of Yggdrasil. The app helps users set goals ranging from daily quests to decade-long epics, with daily check-ins and optional community sharing.

**Package**: `dev.loki.ask`
**Backend**: Supabase
**Platforms**: Android, iOS (via Kotlin Multiplatform)

## Project Structure

```
ALDC/
â”œâ”€â”€ domain/              # Business logic & domain models
â”œâ”€â”€ sharedUI/            # Compose Multiplatform UI (shared across platforms)
â”œâ”€â”€ androidApp/          # Android-specific code
â”œâ”€â”€ iosApp/              # iOS-specific code
â”œâ”€â”€ gradle/              # Gradle wrapper
â””â”€â”€ build.gradle.kts     # Root build configuration
```

### Module Responsibilities

- **domain**: Clean architecture domain layer containing:
  - Models (Motivation, Goal, User, Achievement, etc.)
  - Repositories (interfaces)
  - UseCases (business logic)
  - Types/Enums (Category, Priority, Mood, Gender, etc.)

- **sharedUI**: Compose Multiplatform UI layer containing:
  - Screens (Dashboard, Home, NewMotivation)
  - ViewModels (using MVI pattern with UiState/Event/Effect)
  - Reusable components (Topbar, ReadableIcon, etc.)
  - Navigation (NavRoute)

- **androidApp**: Android-specific implementation
- **iosApp**: iOS-specific implementation

## Tech Stack

### Core Technologies
- **Language**: Kotlin (Multiplatform)
- **UI Framework**: Compose Multiplatform
- **Architecture**: Clean Architecture + MVI pattern
- **DI**: Koin
- **HTTP Client**: Ktorfit
- **Async**: Kotlin Coroutines & Flow
- **Serialization**: Kotlinx Serialization
- **Date/Time**: Kotlinx Datetime
- **Logging**: Kermit
- **Animations**: Compottie (Lottie for Compose Multiplatform)
- **Build**: Gradle with KSP

### Backend
- Supabase (authentication, database, storage)

## Domain Models

Key domain models include:

- **Motivation**: Core entity for user motivations/goals
- **Goal**: User goals with tracking
- **Mission**: Specific tasks or missions
- **Routine**: Recurring activities
- **Achievement**: User achievements
- **CaveDiary**: Journal entries
- **DailyData/MonthlyData**: Calendar tracking data
- **Quote**: Inspirational quotes
- **User**: User profile
- **Milestone**: Goal milestones
- **ThankfulThing**: Gratitude tracking
- **Weakness**: Personal challenges to overcome

### Domain Types
- **Category**: Goal categories
- **Priority**: Task priorities
- **Mood**: User mood tracking
- **Gender**: User gender
- **RepeatType**: Recurring task patterns
- **AdventureStatus**: Status tracking for goals/adventures

## Architecture Patterns

### MVI (Model-View-Intent)
All screens follow MVI pattern:
- **UiState**: Immutable state data class
- **Event**: User interactions/intents
- **Effect**: One-time side effects (navigation, toasts, etc.)
- **ViewModel**: State management

Example:
```kotlin
// Dashboard screen
- DashboardUiState
- DashboardViewModel
- DashboardScreen
```

### Clean Architecture Layers
1. **Domain Layer** (`domain/`): Pure Kotlin, platform-independent
   - Models, UseCases, Repository interfaces
2. **Presentation Layer** (`sharedUI/`): Compose Multiplatform UI
   - ViewModels, Screens, Components
3. **Data Layer** (likely in data module or implementation): Repository implementations

## Use Cases

Organized by feature:

### Calendar
- `GetDailyDataUseCase`
- `GetMonthlyDataUseCase`

### Motivation
- `CreateMotivationUseCase`
- `UpdateMotivationUseCase`
- `DeleteMotivationUseCase`

### User
- `SignInUseCase`
- `SignUpUseCase`
- `GetMyProfileUseCase`
- `UpdateMyProfileUseCase`

### Quote
- `GetTodayQuoteUseCase`

## Development Guidelines

### Code Style
- Follow Kotlin coding conventions
- Use immutable data classes for state
- Prefer composition over inheritance
- Use dependency injection (Koin)
- Keep ViewModels platform-agnostic

### Naming Conventions
- **Screens**: `[Feature]Screen.kt`, `[Feature]ViewModel.kt`, `[Feature]UiState.kt`
- **UseCases**: `[Action][Entity]UseCase.kt` (e.g., `CreateMotivationUseCase`)
- **Repositories**: `[Entity]Repository.kt`
- **Models**: PascalCase, descriptive names

### File Organization
- Group by feature, not by type
- Keep related files together (Screen, ViewModel, UiState in same package)

## Key Features

Based on domain models and screens:

1. **Goal Setting**: Create motivations/goals with categories and priorities
2. **Daily Tracking**: Check-ins and progress updates
3. **Calendar View**: Monthly and daily data visualization
4. **Achievements**: Track and celebrate milestones
5. **Quotes**: Daily inspirational quotes
6. **Community**: Share progress with others (public feed)
7. **Diary/Journal**: Cave diary for reflections
8. **Gratitude Tracking**: Record thankful things
9. **Routine Management**: Recurring tasks and habits

## Navigation

Main routes (defined in `NavRoute.kt`):
- Dashboard
- Home
- NewMotivation
- (Other routes as defined in the app)

## Utilities

- **LocalDateTimeExtensions.kt**: Extension functions for date/time manipulation
- **HapticProperties.kt**: Haptic feedback configuration

## UI Components

Reusable components in `sharedUI/src/commonMain/kotlin/dev/loki/ask/component/`:
- `Topbar`: App bar/toolbar
- `ReadableIcon`: Icon with accessibility support
- `FullWidthTextButton`: Full-width button component
- `GradientCircularProgressIndicator`: Custom progress indicator
- `CircleBgIcon`: Circular background icon

## Build & Development

### IDEs
- Android Studio (recommended for Android/shared code)
- Xcode (required for iOS development)

### Build Commands
```bash
./gradlew build                    # Build all modules
./gradlew :androidApp:assembleDebug # Build Android app
./gradlew :sharedUI:build          # Build shared UI module
./gradlew :domain:build            # Build domain module
```

### Icon Generation
- Use `generate_app_icons.sh` for app icon generation

## CI/CD
See `CI-CD-SETUP.md` for continuous integration and deployment setup.

## MCP Server Configuration

This project uses **Supabase MCP Server** to enable Claude Code to interact directly with the Supabase database.

### Setup Instructions

1. **Copy the example configuration:**
   ```bash
   cp .mcp.json.example .mcp.json
   ```

2. **Edit `.mcp.json` with your Supabase credentials:**
   ```json
   {
     "mcpServers": {
       "supabase": {
         "command": "npx",
         "args": ["-y", "@supabase-community/supabase-mcp"],
         "env": {
           "SUPABASE_URL": "https://your-project-id.supabase.co",
           "SUPABASE_KEY": "your-supabase-anon-key"
         }
       }
     }
   }
   ```

3. **Get your Supabase credentials:**
   - Go to [Supabase Dashboard](https://supabase.com/dashboard)
   - Select your project
   - Settings â†’ API
   - Copy `Project URL` and `anon public` key

### Security Notes

- âš ï¸ **Never commit `.mcp.json`** to Git (already in `.gitignore`)
- âœ… Use **development/staging project** only, not production
- âœ… `.mcp.json.example` is safe to commit (no real credentials)
- ğŸ”’ The `anon` key is protected by Row Level Security (RLS) policies

### Available MCP Commands

Once configured, Claude Code can:
- Query database tables
- Create/update database records
- Run SQL queries
- Manage database schema
- Work with Supabase Storage

### Troubleshooting

- **MCP not working?** Restart Claude Code after editing `.mcp.json`
- **Permission errors?** Check RLS policies in Supabase Dashboard
- **Connection issues?** Verify your project URL and API key

For more details, see: https://github.com/supabase-community/supabase-mcp

## Norse Mythology Theme

The app uses Norse mythology naming and concepts:
- **Ask**: First human created by the gods (app mascot/identity)
- **Yggdrasil**: World tree (community/connection metaphor)
- Goals are "quests" or "adventures"
- Progress tracking as a hero's journey

## Common Tasks

### Adding a New Feature
1. Create domain model in `domain/src/commonMain/kotlin/dev/loki/domain/model/`
2. Create repository interface in `domain/src/commonMain/kotlin/dev/loki/domain/repository/`
3. Create use cases in `domain/src/commonMain/kotlin/dev/loki/domain/usecase/[feature]/`
4. Create screen package in `sharedUI/src/commonMain/kotlin/dev/loki/ask/screen/[feature]/`
5. Implement UiState, ViewModel, and Screen composables
6. Add navigation route in `NavRoute.kt`
7. Wire up DI in Koin modules

### Adding a New UI Component
1. Create in `sharedUI/src/commonMain/kotlin/dev/loki/ask/component/`
2. Make it `@Composable` and platform-agnostic
3. Use material design guidelines
4. Consider accessibility (haptics, screen readers)

## Git Workflow for AI Assistants

### ë¸Œëœì¹˜ ì „ëµ

Claude Codeì™€ ì‘ì—…í•  ë•ŒëŠ” ë‹¤ìŒê³¼ ê°™ì€ ê³„ì¸µì  ë¸Œëœì¹˜ êµ¬ì¡°ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤:

1. **ì„¸ì…˜ ë¸Œëœì¹˜** (Session Branch)
   - ê° Claude ì„¸ì…˜ë§ˆë‹¤ í•˜ë‚˜ì˜ ë©”ì¸ ë¸Œëœì¹˜ ìƒì„±
   - ë„¤ì´ë°: `claude/session-{SESSION_ID}`
   - ì˜ˆì‹œ: `claude/session-51CS3`
   - ì„¸ì…˜ì˜ ëª¨ë“  ì‘ì—…ì„ ìœ„í•œ ë² ì´ìŠ¤ ë¸Œëœì¹˜

2. **í”¼ì²˜ ë¸Œëœì¹˜** (Feature Branch)
   - ì„¸ì…˜ ë‚´ì—ì„œ ê° ê¸°ëŠ¥/í”¼ì²˜ë§ˆë‹¤ ë³„ë„ ë¸Œëœì¹˜ ìƒì„±
   - ë„¤ì´ë°: `claude/session-{SESSION_ID}/{feature-name}`
   - ì˜ˆì‹œ:
     - `claude/session-51CS3/add-login-feature`
     - `claude/session-51CS3/fix-calendar-bug`
     - `claude/session-51CS3/refactor-viewmodel`

3. **ì‘ì—… íë¦„**
   ```bash
   # 1. ì„¸ì…˜ ë¸Œëœì¹˜ ìƒì„± (ì„¸ì…˜ ì‹œì‘ ì‹œ í•œ ë²ˆë§Œ)
   git checkout -b claude/session-{SESSION_ID}

   # 2. í”¼ì²˜ ì‘ì—… ì‹œì‘
   git checkout -b claude/session-{SESSION_ID}/{feature-name}

   # 3. ì‘ì—… ì™„ë£Œ í›„ ì»¤ë°‹
   git add .
   git commit -m "feat: ê¸°ëŠ¥ ì„¤ëª…"

   # 4. í‘¸ì‹œ ë° PR ìƒì„±
   git push -u origin claude/session-{SESSION_ID}/{feature-name}
   gh pr create --base claude/session-{SESSION_ID} --title "í”¼ì²˜ ì œëª©" --body "ì„¤ëª…"

   # 5. ë‹¤ìŒ í”¼ì²˜ë¡œ ì´ë™ (ì„¸ì…˜ ë¸Œëœì¹˜ë¡œ ëŒì•„ê°€ê¸°)
   git checkout claude/session-{SESSION_ID}
   git checkout -b claude/session-{SESSION_ID}/{next-feature-name}
   ```

4. **PR ìƒì„± ê·œì¹™**
   - ê° í”¼ì²˜ ì™„ë£Œ ì‹œ **ë°˜ë“œì‹œ PR ìƒì„±**
   - Base branch: ì„¸ì…˜ ë¸Œëœì¹˜ (`claude/session-{SESSION_ID}`)
   - PR ì œëª©: ëª…í™•í•˜ê³  ê°„ê²°í•˜ê²Œ
   - PR ë³¸ë¬¸: Summary, Test plan, ì„¸ì…˜ ë§í¬ í¬í•¨

5. **ì»¤ë°‹ ë©”ì‹œì§€ ê·œì¹™**
   - Conventional Commits í˜•ì‹ ì‚¬ìš©
   - íƒ€ì…: `feat`, `fix`, `refactor`, `docs`, `test`, `chore`
   - ì˜ˆì‹œ: `feat: Add user authentication`, `fix: Resolve calendar crash`
   - í•­ìƒ ì„¸ì…˜ ë§í¬ í¬í•¨: `https://claude.ai/code/session_{SESSION_ID}`

### ì˜ˆì‹œ ì‹œë‚˜ë¦¬ì˜¤

**ì„¸ì…˜ 51CS3ì—ì„œ 3ê°œì˜ í”¼ì²˜ ì‘ì—…:**

```bash
# ì„¸ì…˜ ë¸Œëœì¹˜ ìƒì„±
git checkout -b claude/session-51CS3

# í”¼ì²˜ 1: ë¡œê·¸ì¸ ê¸°ëŠ¥
git checkout -b claude/session-51CS3/add-login-feature
# ... ì‘ì—… ...
git commit -m "feat: Add login feature"
git push -u origin claude/session-51CS3/add-login-feature
gh pr create --base claude/session-51CS3

# í”¼ì²˜ 2: í”„ë¡œí•„ í™”ë©´
git checkout claude/session-51CS3
git checkout -b claude/session-51CS3/add-profile-screen
# ... ì‘ì—… ...
git commit -m "feat: Add profile screen"
git push -u origin claude/session-51CS3/add-profile-screen
gh pr create --base claude/session-51CS3

# í”¼ì²˜ 3: ë²„ê·¸ ìˆ˜ì •
git checkout claude/session-51CS3
git checkout -b claude/session-51CS3/fix-dashboard-crash
# ... ì‘ì—… ...
git commit -m "fix: Resolve dashboard crash on empty data"
git push -u origin claude/session-51CS3/fix-dashboard-crash
gh pr create --base claude/session-51CS3
```

## Notes for AI Assistants

- This is a **Kotlin Multiplatform** project; code in `commonMain` must be platform-agnostic
- Use **Compose Multiplatform** for UI, not Android-specific Compose APIs
- Follow **MVI pattern** for screens (UiState/Event/Effect)
- Repository implementations are likely in a separate data module (not visible in current structure)
- The app has a **Norse mythology theme**; maintain this aesthetic in naming and UX
- All business logic belongs in **UseCases**, not ViewModels
- ViewModels should be thin orchestrators that call UseCases
- **IMPORTANT**: ìœ„ì˜ Git Workflowë¥¼ ë°˜ë“œì‹œ ë”°ë¥¼ ê²ƒ - ì„¸ì…˜ ë¸Œëœì¹˜ + í”¼ì²˜ë³„ ì„œë¸Œ ë¸Œëœì¹˜ + ê° í”¼ì²˜ë§ˆë‹¤ PR ìƒì„±
